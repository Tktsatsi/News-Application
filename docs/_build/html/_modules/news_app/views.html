

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>news_app.views &mdash; News-application 00.00.01 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d7bb8d4d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            News-application
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">News_app</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">News-application</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">news_app.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for news_app.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Views for the news application.</span>

<span class="sd">This module contains template-based views for the web interface</span>
<span class="sd">and API views for the RESTful API.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthenticationForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoginRequiredMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic</span><span class="w"> </span><span class="kn">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">ListView</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">generics</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">viewsets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ArticleForm</span><span class="p">,</span>
    <span class="n">NewsletterForm</span><span class="p">,</span>
    <span class="n">PublisherForm</span><span class="p">,</span>
    <span class="n">UserRegistrationForm</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Article</span><span class="p">,</span>
    <span class="n">CustomUser</span><span class="p">,</span>
    <span class="n">Newsletter</span><span class="p">,</span>
    <span class="n">Publisher</span><span class="p">,</span>
    <span class="n">PublisherJoinRequest</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsEditor</span><span class="p">,</span> <span class="n">IsJournalist</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.serializers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ArticleCreateSerializer</span><span class="p">,</span>
    <span class="n">ArticleSerializer</span><span class="p">,</span>
    <span class="n">NewsletterCreateSerializer</span><span class="p">,</span>
    <span class="n">NewsletterSerializer</span><span class="p">,</span>
    <span class="n">PublisherSerializer</span><span class="p">,</span>
    <span class="n">SubscriptionArticleSerializer</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="register">
<a class="viewcode-back" href="../../news_app.html#news_app.views.register">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle user registration.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered registration page or redirect on success</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserRegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s2">&quot;Account created for </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;Registration failed. Please check the details and try again.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserRegistrationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/register.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="user_login">
<a class="viewcode-back" href="../../news_app.html#news_app.views.user_login">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">user_login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle user login.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered login page or redirect on success</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Welcome back, </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/login.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="user_logout">
<a class="viewcode-back" href="../../news_app.html#news_app.views.user_logout">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">user_logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle user logout.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Redirect to home page</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You have been logged out successfully!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="home">
<a class="viewcode-back" href="../../news_app.html#news_app.views.home">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display home page with latest approved articles.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered home page with articles</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;articles&quot;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s2">&quot;total_articles&quot;</span><span class="p">:</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/home.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_article">
<a class="viewcode-back" href="../../news_app.html#news_app.views.create_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow journalists to create new articles.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered form or redirect after creation</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only journalists can create articles.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s2">&quot;Article created successfully! It is pending editor approval.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/article_form.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Create New Article&quot;</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="edit_article">
<a class="viewcode-back" href="../../news_app.html#news_app.views.edit_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Journalists can edit their own unapproved articles. Editors can edit any.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Primary key of the article</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :returns: Rendered edit form or redirect after saving</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You can only edit your own articles.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s2">&quot;Cannot edit approved articles. Contact an editor.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You do not have permission to edit articles.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                           <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                           <span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">,</span>
                           <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article_instance</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span> <span class="ow">and</span> <span class="n">article_instance</span><span class="o">.</span><span class="n">is_rejected</span><span class="p">:</span>
                <span class="n">article_instance</span><span class="o">.</span><span class="n">is_rejected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">article_instance</span><span class="o">.</span><span class="n">rejected_reason</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">article_instance</span><span class="o">.</span><span class="n">rejected_by</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">article_instance</span><span class="o">.</span><span class="n">rejected_date</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">article_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article updated successfully!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;article_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/article_form.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Edit Article&quot;</span><span class="p">},</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="delete_article">
<a class="viewcode-back" href="../../news_app.html#news_app.views.delete_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow journalists to delete their own unapproved articles.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Primary key of the article</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :returns: Confirmation page or redirect after deletion</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You can only delete your own articles.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Cannot delete approved articles.&quot;</span>
                       <span class="s2">&quot; Please contact an editor.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article deleted successfully!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_articles&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/article_confirm_delete.html&quot;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<div class="viewcode-block" id="my_articles">
<a class="viewcode-back" href="../../news_app.html#news_app.views.my_articles">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of articles created by the logged-in journalist.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered list of journalist&#39;s articles</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only journalists can access this page.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="n">articles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;approved_by&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;articles&quot;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s2">&quot;pending_count&quot;</span><span class="p">:</span> <span class="n">articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;approved_count&quot;</span><span class="p">:</span> <span class="n">articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/my_articles.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_newsletter">
<a class="viewcode-back" href="../../news_app.html#news_app.views.create_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow journalists to create new newsletters.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: Rendered form or redirect after creation</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only journalists can create newsletters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter created successfully!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_newsletters&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/newsletter_form.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Create New Newsletter&quot;</span><span class="p">},</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="edit_newsletter">
<a class="viewcode-back" href="../../news_app.html#news_app.views.edit_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow journalists to edit their own newsletters.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Primary key of the newsletter</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :returns: Rendered form or redirect after saving</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You can only edit your own newsletters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_newsletters&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                              <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                              <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter updated successfully!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_newsletters&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/newsletter_form.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Edit Newsletter&quot;</span><span class="p">},</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="delete_newsletter">
<a class="viewcode-back" href="../../news_app.html#news_app.views.delete_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow journalists to delete their own newsletters.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the newsletter.</span>
<span class="sd">    :returns: Confirmation page or redirect after deletion.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You can only delete your own newsletters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_newsletters&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter deleted successfully!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;my_newsletters&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/newsletter_confirm_delete.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">},</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="my_newsletters">
<a class="viewcode-back" href="../../news_app.html#news_app.views.my_newsletters">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_newsletters</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of newsletters created by the logged-in journalist.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered list of journalist&#39;s newsletters.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only journalists can access this page.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="n">newsletters</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;newsletters&quot;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
        <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">newsletters</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/my_newsletters.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="NewsletterListView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterListView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewsletterListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of all newsletters.</span>

<span class="sd">    :param: None</span>
<span class="sd">    :returns: ListView rendering newsletters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Newsletter</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;news_app/newsletter_list.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;newsletters&quot;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="NewsletterListView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterListView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get queryset of newsletters.</span>

<span class="sd">        :returns: QuerySet of newsletters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NewsletterDetailView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterDetailView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewsletterDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display detailed view of a single newsletter.</span>

<span class="sd">    Shows full newsletter content, author information, and subscription</span>
<span class="sd">    options for authenticated users.</span>

<span class="sd">    :ivar model: Newsletter model class</span>
<span class="sd">    :ivar template_name: Template to render</span>
<span class="sd">    :ivar context_object_name: Name of newsletter object in template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Newsletter</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;news_app/newsletter_detail.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;newsletter&quot;</span>

<div class="viewcode-block" id="NewsletterDetailView.get_context_data">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterDetailView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add related newsletters to context.</span>

<span class="sd">        :param kwargs: Additional context kwargs.</span>
<span class="sd">        :returns: Context dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;related_newsletters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
            <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>
</div>



<div class="viewcode-block" id="ArticleListView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleListView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticleListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of approved articles.</span>

<span class="sd">    Shows paginated list of all approved articles, ordered by</span>
<span class="sd">    publication date (newest first).</span>

<span class="sd">    :ivar model: Article model class</span>
<span class="sd">    :ivar template_name: Template to render</span>
<span class="sd">    :ivar context_object_name: Name of articles queryset in template</span>
<span class="sd">    :ivar paginate_by: Number of articles per page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;news_app/article_list.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;articles&quot;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="ArticleListView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleListView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return only approved articles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ArticleDetailView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleDetailView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticleDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display detailed view of a single article.</span>

<span class="sd">    Shows full article content with permissions:</span>
<span class="sd">    - Public: Only approved articles</span>
<span class="sd">    - Editors: All articles</span>
<span class="sd">    - Journalists: Approved articles + their own articles</span>

<span class="sd">    :ivar model: Article model class</span>
<span class="sd">    :ivar template_name: Template to render</span>
<span class="sd">    :ivar context_object_name: Name of article object in template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;news_app/article_detail.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;article&quot;</span>

<div class="viewcode-block" id="ArticleDetailView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleDetailView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return articles based on user permissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PendingArticlesView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.PendingArticlesView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PendingArticlesView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of articles pending approval (editors only).</span>

<span class="sd">    Shows all articles that are not yet approved or rejected,</span>
<span class="sd">    allowing editors to review and approve/reject them.</span>

<span class="sd">    :ivar model: Article model class</span>
<span class="sd">    :ivar template_name: Template to render</span>
<span class="sd">    :ivar context_object_name: Name of articles queryset in template</span>
<span class="sd">    :ivar paginate_by: Number of articles per page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;news_app/pending_articles.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;articles&quot;</span>

<div class="viewcode-block" id="PendingArticlesView.dispatch">
<a class="viewcode-back" href="../../news_app.html#news_app.views.PendingArticlesView.dispatch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure user is an editor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;article_list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PendingArticlesView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.PendingArticlesView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return unapproved, not rejected articles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_rejected</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="approve_article">
<a class="viewcode-back" href="../../news_app.html#news_app.views.approve_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">approve_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approve an article for publication.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the article.</span>
<span class="sd">    :returns: Redirect or rendered confirmation.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_rejected</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;This article was rejected and cannot be approved.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;pending_articles&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;This article is already approved.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;pending_articles&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">article</span><span class="o">.</span><span class="n">approved_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">article</span><span class="o">.</span><span class="n">approval_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;pending_articles&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/approve_article.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<div class="viewcode-block" id="reject_article">
<a class="viewcode-back" href="../../news_app.html#news_app.views.reject_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reject_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reject an article and record reason.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the article.</span>
<span class="sd">    :returns: Redirect after rejection or rendered form.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">article</span><span class="o">.</span><span class="n">is_rejected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">article</span><span class="o">.</span><span class="n">rejected_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">article</span><span class="o">.</span><span class="n">rejected_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">rejected_reason</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article rejected.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;pending_articles&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/reject_article.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<div class="viewcode-block" id="publish_independently">
<a class="viewcode-back" href="../../news_app.html#news_app.views.publish_independently">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_independently</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Publish an article independently by its author.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the article.</span>
<span class="sd">    :returns: Rendered my_articles page with message.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">independently_published</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">article</span><span class="o">.</span><span class="n">approval_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">article</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Your article has been published independently.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/my_articles.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<div class="viewcode-block" id="dashboard">
<a class="viewcode-back" href="../../news_app.html#news_app.views.dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display role-specific dashboard.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered dashboard page.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;subscribed_newsletters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;latest_articles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="s2">&quot;-published_date&quot;</span>
                <span class="p">)[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;pending_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;approved_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">approved_by</span><span class="o">=</span><span class="n">user</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;recent_pending&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="s2">&quot;-created_at&quot;</span>
        <span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;my_articles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">independent_articles</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;approved_articles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">independent_articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;pending_articles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">independent_articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;total_newsletters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">independent_newsletters</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/dashboard.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_publisher">
<a class="viewcode-back" href="../../news_app.html#news_app.views.create_publisher">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow users with &#39;publisher&#39; role to create a Publisher.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered form or redirect after creation.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;publisher&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Only users with publisher role can create publishers.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="c1"># Prevent a publisher user from having multiple publishers</span>
    <span class="n">existing_publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">existing_publisher</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;You already own </span><span class="si">{</span><span class="n">existing_publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_dashboard&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">existing_publisher</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1">#  AUTO-ASSIGN OWNER</span>
            <span class="n">publisher</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">publisher</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;Publisher &quot;</span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; created successfully! You are now the owner.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_dashboard&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">publisher</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;news_app/publisher_form.html&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Create Publisher&quot;</span><span class="p">},</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="publisher_list">
<a class="viewcode-back" href="../../news_app.html#news_app.views.publisher_list">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">publisher_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of all publishers.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered publisher list page.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/publisher_list.html&quot;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s2">&quot;publishers&quot;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">})</span></div>



<div class="viewcode-block" id="publisher_detail">
<a class="viewcode-back" href="../../news_app.html#news_app.views.publisher_detail">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">publisher_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display detailed view of a single publisher.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the publisher.</span>
<span class="sd">    :returns: Rendered publisher detail page.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">recent_articles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">is_member</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">can_request_join</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
            <span class="n">is_member</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="n">can_request_join</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_member</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
            <span class="n">is_member</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="n">can_request_join</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_member</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="s2">&quot;recent_articles&quot;</span><span class="p">:</span> <span class="n">recent_articles</span><span class="p">,</span>
        <span class="s2">&quot;editors&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;journalists&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;is_member&quot;</span><span class="p">:</span> <span class="n">is_member</span><span class="p">,</span>
        <span class="s2">&quot;can_request_join&quot;</span><span class="p">:</span> <span class="n">can_request_join</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/publisher_detail.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="request_join_publisher">
<a class="viewcode-back" href="../../news_app.html#news_app.views.request_join_publisher">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">request_join_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Only journalists/editors can join</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;journalist&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">]:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Only journalists and editors can request to join.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Prevent multiple active requests</span>
    <span class="k">if</span> <span class="n">PublisherJoinRequest</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="s2">&quot;You already submitted a request to this publisher.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
        <span class="n">portfolio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span>

        <span class="n">PublisherJoinRequest</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Your request has been submitted!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/request_join_publisher.html&quot;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">})</span></div>



<div class="viewcode-block" id="publisher_join_requests">
<a class="viewcode-back" href="../../news_app.html#news_app.views.publisher_join_requests">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publisher_join_requests</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display all join requests (pending, approved, rejected) for a publisher.</span>

<span class="sd">    Publishers can view and manage join requests for their publisher</span>
<span class="sd">    organization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">publisher</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;You must be a publisher owner to view join requests.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;dashboard&quot;</span><span class="p">)</span>

    <span class="c1"># Get filter parameter (default to &#39;pending&#39;)</span>
    <span class="n">status_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span>

    <span class="c1"># Validate status filter</span>
    <span class="n">valid_statuses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;approved&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">status_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_statuses</span><span class="p">:</span>
        <span class="n">status_filter</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>

    <span class="c1"># Get all requests for this publisher</span>
    <span class="n">all_requests</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PublisherJoinRequest</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;reviewed_by&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Filter by status</span>
    <span class="k">if</span> <span class="n">status_filter</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">requests_list</span> <span class="o">=</span> <span class="n">all_requests</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">requests_list</span> <span class="o">=</span> <span class="n">all_requests</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status_filter</span><span class="p">)</span>

    <span class="c1"># Count requests by status</span>
    <span class="n">pending_count</span> <span class="o">=</span> <span class="n">all_requests</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">approved_count</span> <span class="o">=</span> <span class="n">all_requests</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;approved&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">rejected_count</span> <span class="o">=</span> <span class="n">all_requests</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;rejected&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="n">all_requests</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="s2">&quot;requests_list&quot;</span><span class="p">:</span> <span class="n">requests_list</span><span class="p">,</span>
        <span class="s2">&quot;status_filter&quot;</span><span class="p">:</span> <span class="n">status_filter</span><span class="p">,</span>
        <span class="s2">&quot;pending_count&quot;</span><span class="p">:</span> <span class="n">pending_count</span><span class="p">,</span>
        <span class="s2">&quot;approved_count&quot;</span><span class="p">:</span> <span class="n">approved_count</span><span class="p">,</span>
        <span class="s2">&quot;rejected_count&quot;</span><span class="p">:</span> <span class="n">rejected_count</span><span class="p">,</span>
        <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/publisher_join_requests.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="publisher_dashboard">
<a class="viewcode-back" href="../../news_app.html#news_app.views.publisher_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publisher_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display publisher dashboard for editors.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param pk: Primary key of the publisher.</span>
<span class="sd">    :returns: Rendered dashboard page.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Who can access this dashboard</span>
    <span class="n">is_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">publisher</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">is_editor</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="c1"># Only owner OR editor can open dashboard</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_owner</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;You do not have permission to access this publisher dashboard.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Only show join requests if user is the OWNER</span>
    <span class="n">pending_requests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">is_owner</span><span class="p">:</span>
        <span class="n">pending_requests</span> <span class="o">=</span> <span class="n">PublisherJoinRequest</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>

    <span class="n">members</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="s2">&quot;is_owner&quot;</span><span class="p">:</span> <span class="n">is_owner</span><span class="p">,</span>   <span class="c1"># &lt; template needs this</span>
        <span class="s2">&quot;pending_requests&quot;</span><span class="p">:</span> <span class="n">pending_requests</span><span class="p">,</span>
        <span class="s2">&quot;editors&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;journalists&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;articles&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">10</span><span class="p">],</span>
        <span class="s2">&quot;members&quot;</span><span class="p">:</span> <span class="n">members</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/publisher_dashboard.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="approve_join_request">
<a class="viewcode-back" href="../../news_app.html#news_app.views.approve_join_request">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">approve_join_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approve a join request to a publisher.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param request_id: Primary key of the join request.</span>
<span class="sd">    :returns: Redirect to publisher dashboard.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">join_req</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PublisherJoinRequest</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request_id</span><span class="p">)</span>

    <span class="c1"># Only the publisher owner can approve</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">owner</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;You are not allowed to approve this request.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_dashboard&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Update join request</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;approved&quot;</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">reviewed_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">reviewed_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
        <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> has been added to the team.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_join_requests&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="reject_join_request">
<a class="viewcode-back" href="../../news_app.html#news_app.views.reject_join_request">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reject_join_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reject a join request to a publisher.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param request_id: Primary key of the join request.</span>
<span class="sd">    :returns: Redirect to publisher dashboard.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">join_req</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PublisherJoinRequest</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">owner</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;You are not allowed to approve this request.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_dashboard&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="n">join_req</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;rejected&quot;</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">reviewed_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">reviewed_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">join_req</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Join request from </span><span class="si">{</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> has been rejected.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_join_requests&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
        <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
        <span class="n">join_req</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">join_req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;s request was rejected.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;publisher_join_requests&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="web_subscribe_to_journalist">
<a class="viewcode-back" href="../../news_app.html#news_app.views.web_subscribe_to_journalist">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">web_subscribe_to_journalist</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe to a journalist (HTML view).</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param journalist_id: ID of the journalist.</span>
<span class="sd">    :returns: Redirect back to journalist list.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only readers may subscribe to journalists.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;journalist_list&quot;</span><span class="p">)</span>

    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span>
                                   <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                                   <span class="n">role</span><span class="o">=</span><span class="s2">&quot;journalist&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">journalist</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;You are already subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;journalist_list&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="web_unsubscribe_from_journalist">
<a class="viewcode-back" href="../../news_app.html#news_app.views.web_unsubscribe_from_journalist">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">web_unsubscribe_from_journalist</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unsubscribe from a journalist (HTML view).</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param journalist_id: ID of the journalist.</span>
<span class="sd">    :returns: Redirect back to journalist list.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only readers may unsubscribe.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;journalist_list&quot;</span><span class="p">)</span>

    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span>
                                   <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                                   <span class="n">role</span><span class="o">=</span><span class="s2">&quot;journalist&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">journalist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;You were not subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s2">&quot;Unsubscribed from </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;journalist_list&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="subscribe_newsletter">
<a class="viewcode-back" href="../../news_app.html#news_app.views.subscribe_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscribe_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web interface to subscribe to a newsletter.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param newsletter_id: ID of the newsletter.</span>
<span class="sd">    :returns: Redirect to newsletter detail.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">]:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Only readers and editors can subscribe to newsletters.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;newsletter_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>

    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newsletter</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;You are already subscribed to </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s2">&quot;Successfully subscribed to </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;newsletter_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span></div>



<div class="viewcode-block" id="unsubscribe_newsletter">
<a class="viewcode-back" href="../../news_app.html#news_app.views.unsubscribe_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web interface to unsubscribe from a newsletter.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param newsletter_id: ID of the newsletter.</span>
<span class="sd">    :returns: Redirect to newsletter detail.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">]:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Only readers and editors can manage newsletter subscriptions.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;newsletter_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>

    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newsletter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;You are not subscribed to </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s2">&quot;Successfully unsubscribed from </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;newsletter_detail&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span></div>



<div class="viewcode-block" id="subscription_dashboard">
<a class="viewcode-back" href="../../news_app.html#news_app.views.subscription_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscription_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display user&#39;s subscriptions dashboard.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered subscription dashboard.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">]:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Only readers and editors have subscriptions.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;subscribed_newsletters&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_newsletters</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;subscribed_publishers&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;subscribed_journalists&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My Subscriptions&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;news_app/subscription_dashboard.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="journalist_list">
<a class="viewcode-back" href="../../news_app.html#news_app.views.journalist_list">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">journalist_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display list of all journalists.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :returns: Rendered journalist list page.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">journalists</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;journalist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s2">&quot;news_app/journalist_list.html&quot;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s2">&quot;journalists&quot;</span><span class="p">:</span> <span class="n">journalists</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Journalists&quot;</span><span class="p">})</span></div>



<div class="viewcode-block" id="ArticleViewSet">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticleViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ViewSet for Article CRUD operations via API.</span>

<span class="sd">    Provides full CRUD functionality for articles with role-based</span>
<span class="sd">    permissions:</span>
<span class="sd">    - Journalists: Can create articles</span>
<span class="sd">    - Editors: Can update/delete any article</span>
<span class="sd">    - All authenticated users: Can view approved articles</span>

<span class="sd">    :ivar queryset: Base queryset for articles</span>
<span class="sd">    :ivar permission_classes: Base permission classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="ArticleViewSet.get_serializer_class">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return serializer class depending on action.</span>

<span class="sd">        :returns: ArticleCreateSerializer for create action,</span>
<span class="sd">        ArticleSerializer for all other actions</span>
<span class="sd">        :rtype: class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ArticleCreateSerializer</span>
        <span class="k">return</span> <span class="n">ArticleSerializer</span></div>


<div class="viewcode-block" id="ArticleViewSet.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleViewSet.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return articles filtered by user role.</span>

<span class="sd">        :returns: Filtered articles based on user role</span>
<span class="sd">        (Editors: All articles, Journalists: Approved + own, Others: Approved only)</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;editor&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;journalist&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArticleViewSet.get_permissions">
<a class="viewcode-back" href="../../news_app.html#news_app.views.ArticleViewSet.get_permissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return permission instances for actions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Permission classes based on action:</span>
<span class="sd">                - create: IsJournalist</span>
<span class="sd">                - update/partial_update/destroy: IsEditor</span>
<span class="sd">                - Other: IsAuthenticated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsJournalist</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;partial_update&quot;</span><span class="p">,</span> <span class="s2">&quot;destroy&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsEditor</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">()]</span></div>
</div>



<div class="viewcode-block" id="NewsletterViewSet">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewsletterViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ViewSet for Newsletter CRUD operations via API.</span>

<span class="sd">    Provides full CRUD functionality for newsletters with role-based</span>
<span class="sd">    permissions:</span>
<span class="sd">    - Journalists: Can create newsletters</span>
<span class="sd">    - Editors: Can update/delete any newsletter</span>
<span class="sd">    - All authenticated users: Can view newsletters</span>

<span class="sd">    :ivar queryset: Base queryset for newsletters</span>
<span class="sd">    :ivar permission_classes: Base permission classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="NewsletterViewSet.get_serializer_class">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return serializer class depending on action.</span>

<span class="sd">        :returns: NewsletterCreateSerializer for create action, NewsletterSerializer for all other actions</span>
<span class="sd">        :rtype: class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NewsletterCreateSerializer</span>
        <span class="k">return</span> <span class="n">NewsletterSerializer</span></div>


<div class="viewcode-block" id="NewsletterViewSet.get_permissions">
<a class="viewcode-back" href="../../news_app.html#news_app.views.NewsletterViewSet.get_permissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return permission instances for actions.</span>

<span class="sd">        :returns: Permission classes based on action (create: IsJournalist, update/delete: IsEditor, other: IsAuthenticated)</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsJournalist</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;partial_update&quot;</span><span class="p">,</span> <span class="s2">&quot;destroy&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsEditor</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">()]</span></div>
</div>



<div class="viewcode-block" id="PublisherViewSet">
<a class="viewcode-back" href="../../news_app.html#news_app.views.PublisherViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PublisherViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ViewSet for Publisher read-only operations via API.</span>

<span class="sd">    Provides read-only access to publishers. Includes custom action</span>
<span class="sd">    to retrieve articles for a specific publisher.</span>

<span class="sd">    :ivar queryset: Base queryset for publishers</span>
<span class="sd">    :ivar serializer_class: Serializer for publisher data</span>
<span class="sd">    :ivar permission_classes: Base permission classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PublisherSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="PublisherViewSet.articles">
<a class="viewcode-back" href="../../news_app.html#news_app.views.PublisherViewSet.articles">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">articles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get approved articles for a specific publisher.</span>

<span class="sd">        Custom API action to retrieve all approved articles</span>
<span class="sd">        published by a specific publisher.</span>

<span class="sd">        :param request: HTTP request object</span>
<span class="sd">        :type request: HttpRequest</span>
<span class="sd">        :param pk: Primary key of the publisher</span>
<span class="sd">        :type pk: int</span>
<span class="sd">        :returns: Paginated list of approved articles</span>
<span class="sd">        :rtype: Response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                                          <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">ArticleSerializer</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ArticleSerializer</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="JournalistArticlesView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.JournalistArticlesView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JournalistArticlesView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API view to retrieve articles by a specific journalist.</span>

<span class="sd">    Returns a paginated list of approved articles authored by</span>
<span class="sd">    the specified journalist.</span>

<span class="sd">    :ivar serializer_class: Serializer for article data</span>
<span class="sd">    :ivar permission_classes: Permission classes required</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ArticleSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="JournalistArticlesView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.JournalistArticlesView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get queryset of approved articles by journalist.</span>

<span class="sd">        :returns: Approved articles by the specified journalist, ordered by publication date (newest first)</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">journalist_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journalist_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author_id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                                      <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SubscriptionArticlesView">
<a class="viewcode-back" href="../../news_app.html#news_app.views.SubscriptionArticlesView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SubscriptionArticlesView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API view for retrieving articles based on user subscriptions.</span>

<span class="sd">    Returns articles from publishers and journalists that the</span>
<span class="sd">    authenticated reader is subscribed to. Only available to readers.</span>

<span class="sd">    :ivar serializer_class: Serializer for subscription article data</span>
<span class="sd">    :ivar permission_classes: Permission classes required</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SubscriptionArticleSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="SubscriptionArticlesView.get_queryset">
<a class="viewcode-back" href="../../news_app.html#news_app.views.SubscriptionArticlesView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get queryset of articles from user&#39;s subscriptions.</span>

<span class="sd">        :returns: Approved articles from subscribed publishers and journalists,</span>
<span class="sd">        ordered by publication date. Returns empty queryset if user is not a reader</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">subscribed_publishers</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">subscribed_journalists</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">publisher__in</span><span class="o">=</span><span class="n">subscribed_publishers</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">author__in</span><span class="o">=</span><span class="n">subscribed_journalists</span><span class="p">),</span>
                <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-published_date&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">articles</span></div>
</div>



<div class="viewcode-block" id="subscribe_to_publisher">
<a class="viewcode-back" href="../../news_app.html#news_app.views.subscribe_to_publisher">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscribe_to_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe the authenticated user to a publisher.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param publisher_id: ID of the publisher to subscribe to</span>
<span class="sd">    :type publisher_id: int</span>
<span class="sd">    :returns: JSON response indicating success or error</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Only readers can subscribe to publishers&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Already subscribed to </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully subscribed to </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">}},</span>
        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="unsubscribe_from_publisher">
<a class="viewcode-back" href="../../news_app.html#news_app.views.unsubscribe_from_publisher">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_from_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unsubscribe the authenticated user from a publisher.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param publisher_id: ID of the publisher to unsubscribe from</span>
<span class="sd">    :type publisher_id: int</span>
<span class="sd">    :returns: JSON response indicating success or error</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Only readers can manage subscriptions&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">publisher</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Not subscribed to </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully unsubscribed from </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>



<div class="viewcode-block" id="subscribe_to_journalist">
<a class="viewcode-back" href="../../news_app.html#news_app.views.subscribe_to_journalist">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscribe_to_journalist</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe the authenticated user to a journalist.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param journalist_id: ID of the journalist to subscribe to</span>
<span class="sd">    :type journalist_id: int</span>
<span class="sd">    :returns: JSON response indicating success or error</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Only readers can subscribe to journalists&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                                   <span class="n">role</span><span class="o">=</span><span class="s2">&quot;journalist&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">journalist</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Already subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="s2">&quot;journalist&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">journalist</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="p">}},</span>
        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="unsubscribe_from_journalist">
<a class="viewcode-back" href="../../news_app.html#news_app.views.unsubscribe_from_journalist">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_from_journalist</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unsubscribe the authenticated user from a journalist.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param journalist_id: ID of the journalist to unsubscribe from</span>
<span class="sd">    :type journalist_id: int</span>
<span class="sd">    :returns: JSON response indicating success or error</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Only readers can manage subscriptions&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span>
                                   <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;journalist&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">journalist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Not subscribed to </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully unsubscribed from </span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>



<div class="viewcode-block" id="my_subscriptions">
<a class="viewcode-back" href="../../news_app.html#news_app.views.my_subscriptions">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_subscriptions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all subscriptions for the authenticated user.</span>

<span class="sd">    Returns a list of all publishers and journalists the user</span>
<span class="sd">    is subscribed to. Only available to readers.</span>

<span class="sd">    :param request: HTTP request object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :returns: JSON response with lists of subscribed publishers and journalists, or error if user is not a reader</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;reader&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Only readers have subscriptions&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="n">publishers</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">journalists</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;publishers&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                 <span class="s2">&quot;website&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">website</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">publishers</span>
            <span class="p">],</span>
            <span class="s2">&quot;journalists&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                 <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                 <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                 <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">journalists</span>
            <span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tshidiso Tsatsi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>